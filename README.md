项目背景：我们有一些类似`data/Image_20250710125452500.bmp`格式的线阵相机拍摄的到的图片。该图片中白色条状物拍摄的是钢材被圆盘剪刀剪出的截面，理论上来说，该条状物可以分为“撕裂面”和“剪切面”，图中两个面左右两边宽度不等，我的任务是设计一个cv算法学习根据图片截面的特征判断是否该更换剪刀。 根据经验更换剪刀时一般撕裂面：剪切面的比例会变大。且撕裂面会出现较多的白色斑块，一般几个小时会更换一次，我想判断出最佳换剪刀的时间。 要求： 算法要实时检测；需要学到撕裂面和剪切面的比例变化曲线；需要学到撕裂面斑块数目变化曲线或趋势； 请你帮我设计一个算法方案，要根据这种图的特点进行分析选择最合适的算法。并写出具体的数据集制作方法和制作规模；设计好评测指标；大概给出可能的性能评估；

代码方案设计草稿：
```Markdown
下面是一套从**思路 → 算法设计 → 数据集制作 → 训练/评估 → 部署与运行时决策**的完整方案，专门针对你这种线阵相机拍到的 `.bmp` 截面图（“白色条状物”包含 **撕裂面** 与 **剪切面** 两类区域），目标是**实时检测并给出剪刀更换时机**（基于撕裂面/剪切面比例和撕裂面白斑数量的时序变化）。

我把方案分成若干模块，每个模块给出可立刻实施的细节、超参建议、评测指标以及可能的性能预估。若要我直接给训练代码/训练脚本、或根据你现有样本做一次原型（例如用你容器里的 `.bmp` 做小试验），我可以立刻做，但本回答先把算法与工程蓝图梳理完整。

# 1 关键设计思路（要点）

- 目标量化指标
  - 撕裂面 / 剪切面 比例：R(t)=Atear(t)Ashear(t) 或可用归一化比例 Ptear(t)=AtearAtear+Ashear。
  - 撕裂面白色斑块数（或斑块密度）：B(t)（connected components 数或大于阈值的白点像素占比）。
- 两条并行路线（短期 + 长期）
  - **短期（可立刻部署，轻量）**：传统 CV 规则化流水线（阈值、形态学、连通域等）提取两个区域与斑块计数。优点快速、易解释、实时延迟低。
  - **长期（更稳健）**：轻量语义分割 / 二分类像素级网络（例如小型 U-Net / DeepLab-MobileNet / SegFormer-lite）用于将像素分为：`background` / `撕裂面` / `剪切面`。网络输出更健壮，适应光照、灰度漂移、噪声。
- 时序建模与决策
  - 对 Ptear(t) 与 B(t) 做滑窗/平滑（EMA）并存储时间序列；
  - 使用统计/变化点检测（CUSUM、Bayesian online changepoint、or simple threshold + hysteresis）来触发“预警/更换建议”；
  - 可选：用小型时间序列模型（ARIMA / LightGBM on windows / LSTM）学习趋势并预测“到何时会超过阈值”以得到更佳换刀时机（提前预警）。

# 2 详细算法流水线（最终部署建议：短期规则+长期模型并行，输出融合）

## 2.1 输入与预处理（通用）

- 输入：单幅线阵截面图（灰度或单通道白底黑背景常见）
- 预处理：
  1. 读入并转为灰度（若是单通道可跳过）。
  2. 直方图/CLAHE 自适应对比度增强（对抗光照漂移）。
  3. 高斯去噪（kernel 3~5）。
  4. 如线阵一维特性明显，先裁 ROI：选定图像中心竖条或横条，减少计算量。
  5. 标准化到固定分辨率（例如长边保持原始像素，短边 resize 到 256 或 512 以保证速度/精度平衡）。

## 2.2 传统 CV 管道（轻量可实时）

- 二值化：自适应阈值（局部 Otsu 或 Sauvola），或直接 Otsu 后结合固定阈值。
- 形态学：闭运算消除小空洞，开运算去除细小噪点（kernel 3~7）。
- 连通域与轮廓提取：找到白色连通区域 → 根据形状（长宽比、面积）把主要条状物分离出来；条状物左右分成两个走向（依据中轴线或边界点），然后在条状物内部进一步用边界/梯度区分“撕裂面”与“剪切面”：
  - 分割策略（启发式）：沿条状物中心线计算像素强度梯度或边界曲率，剪切面通常更平整、边界连续；撕裂面边界更锯齿/不规则且含斑点。
  - 如果两个面左右明显，用中轴或轮廓切分（根据几何先验：两个面左右两侧宽度不等）。
- 斑块计数：在撕裂面区域内做开操作后找连通小块，按面积阈值（>A_min）计数，得到 B(t)。
- 输出：Atear,Ashear,Ptear,B。

优点：实现快（CPU即可），可在数十到数百 FPS（取决于分辨率与CPU）运行。

## 2.3 深度学习语义分割管道（长期，稳健）

- 标签：像素级三类：`0 background`, `1 tear`, `2 shear`。
- 网络备选（轻量、易部署）：
  - MobileNetV3-UNet-like（encoder: MobileNetV3 small，decoder: lightweight upsampling）；
  - DeepLabV3-MobileNet 或 SegFormer-lite；
  - 若你要极致速度：ENet / FastSCNN。
- 损失：`CrossEntropy + DiceLoss`（处理类不平衡）。
- 后处理：连通域、面积过滤，输出同上指标。网络输出更好的边界、能容忍光照/噪声变化。
- 训练/推理：
  - 输入尺寸：512×128 或 1024×256，取决于线阵图像的形状（宽高比）。
  - batch size 与 lr 按 GPU 规格调整。
  - 模型导出：ONNX → TensorRT / OpenVINO / TVM，以实现低延迟部署。

## 2.4 时序决策（如何判断“该换刀”）

- 实时计算滑动窗口（例如 last 5~60 分钟的窗口，或 last N 帧）：
  - 使用指数移动平均（EMA）： P^tear(t)=αPtear(t)+(1−α)P^tear(t−1) ，α 取 0.1~0.3。
  - 计算 B(t) 的移动均值与斜率（用线性回归拟合窗口内点）。
- 变化点/告警策略（组合）：
  1. **阈值+滞后**：若 Ptear 连续超过阈值 TP（例如 0.6）且持续超过 Tdur（例如 5 分钟），触发警告。
  2. **增长率**：若短时段内 Ptear 增幅 > Rdelta（例如 10%）触发预警。
  3. **斑块数**：若 B(t) 超过阈值或增速显著，触发更高等级警报。
  4. **融合逻辑**：两者同时异常（高 Ptear 且高 B）则立即建议更换；单一异常则建议观察/短期复测。
- 进一步：用 CUSUM 或 Bayesian change point 检测更鲁棒地捕捉突变点并减少误报。

# 3 数据集制作（关键与详尽步骤）

> 目标：训练稳健语义分割模型并验证时序决策。数据集要覆盖“正常刀具”→“磨损/待换刀”全过程（多个刀具/班次/光照/材料差异）。

## 3.1 标注格式

- 每张图片保存：
  - 原图 `.bmp` 或 `.png`；
  - 像素标签 mask（单通道 uint8）：0=background, 1=tear, 2=shear；
  - 元数据 `.json`：`{"timestamp": "...", "tool_id": "...", "operator": "...", "shift": "...", "temperature": "...", "notes": "..."}`
- 另外，为时序任务每 N 帧记录一个“人工更换标签”：`change_time`（精确到帧或分钟）。

## 3.2 数据量（推荐）

- **最小可用集（快速原型）**：
  - 1,000 ~ 2,000 帧（多把刀，多次更换周期），尽量包含不同磨损阶段。
- **建议生产级集**：
  - 5,000 ~ 20,000 帧：覆盖 10~20 把刀、每把刀在使用从新到报废（或换刀）的完整周期中均抽取样本。
  - 每把刀至少 300~1,000 帧，且在更换前后高密度采样（例如每分钟 1~5 帧更高采样率）。
- **标注分配**：
  - Train/Val/Test 按刀具周期拆分（非常重要）：例如用部分刀具的完整周期作为训练，留出不同时间/不同刀具用于测试，避免过拟合到单把刀的特性。
```

第一步：
先给出预处理步骤的代码，要求： 
  1.我们首先应该提取图片的有效部分，因为从图片来看图片存在大面积黑色背景，白色条状物仅占比很小的部分，所以，我们需要利用你上面提到的各种预处理手段将图片处理成主要包含条状物的图片部分，然后处理成利于用算法去学习或统计的格式； 
  2.你应该先给出具体处理步骤以及原理，再给出具体的代码实现，并用上面的图片进行测试；

--------- 后面步骤先不做 --------

---

## 最新更新记录

### 2025-01-08: 新增水平梯度能量特征

**功能说明**：
- 在原有的"总梯度能量"基础上，新增了"水平梯度能量"特征
- 水平梯度只计算x方向（水平方向）的Sobel梯度，专门用于捕捉垂直边缘（刀口边缘）的锐度变化
- 相比总梯度（包含x和y两个方向），水平梯度对剪刀磨损导致的边缘钝化更加敏感

**技术原理**：
```python
# 总梯度能量（原有）
grad_x = cv2.Sobel(image, cv2.CV_64F, 1, 0, ksize=3)
grad_y = cv2.Sobel(image, cv2.CV_64F, 0, 1, ksize=3)
energy = mean(grad_x² + grad_y²)  # 包含所有方向

# 水平梯度能量（新增）
grad_x = cv2.Sobel(image, cv2.CV_64F, 1, 0, ksize=3)
energy = mean(grad_x²)  # 仅水平方向
```

**物理意义**：
- 水平梯度主要反映垂直边缘（剪刀的竖直切割面）的锐度
- 刀口锋利时：垂直边缘清晰，水平梯度大
- 刀口磨钝时：垂直边缘模糊，水平梯度显著下降
- **下降趋势**表示刀口钝化，磨损加重

**新增可视化**：
在运行 `coil_wear_analysis.py` 后会自动生成 `horizontal_gradient_comparison.png`，包含4个子图：
1. **时序对比图**：总梯度 vs 水平梯度的完整时序变化（原始+平滑）
2. **按卷统计图**：各钢卷的平均梯度能量柱状图对比
3. **归一化趋势图**：归一化后的梯度能量变化，更清晰展示趋势差异
4. **变化率统计**：首尾变化率对比，负值表示下降（磨损加重）

**使用方法**：
```bash
# 运行磨损分析脚本会自动包含新特征
python coil_wear_analysis.py --roi_dir data/roi_imgs --output_dir data/analysis --name "测试"

# 输出文件中会包含：
# - features/wear_features.csv 中的 avg_horizontal_gradient 列
# - visualizations/horizontal_gradient_comparison.png 专项对比图
```

**特征命名**：
- `left_horizontal_gradient`: 左侧（撕裂面）水平梯度能量
- `right_horizontal_gradient`: 右侧（剪切面）水平梯度能量  
- `avg_horizontal_gradient`: 左右平均水平梯度能量

第二步：
确认模型，并写出demo;

第三步：
确认数据集制作步骤，并写出每个步骤的脚本；




第四步：
快速原型验证，要求：
需要验证方案的可行性，验证数据：

```Markdown
data/Video_20250821110325928.avi
00:00-00:17 第4卷
00:17:00 开始第5卷
00:34:00 第6卷 // 前⾯⽐较糊，后⾯还好，也可能是速度稳定了
00:57:00 第7卷
01:16:00 8卷
01:34:00 第9卷
01:57:00 第10卷
02:20:00第11卷
02:39:00 - 02:58:00 第12卷
换圆盘剪

data/Video_20250821140339629.avi
00:00:00 第1卷
00:18:37 第2卷
00:36:45 第3卷
00:57:00 第4卷
01:17:07 第5卷
```

这两个视频完整记录了第一个剪刀到第二个剪刀的更换过程；第一个剪刀剪了12卷；大约2小时58分钟；

验证期望：我们的模型应该能够画出整个工作过程的大体曲线。
曲线一：纵轴是“撕裂面”/“剪切面”比值变化；横轴是时间；
曲线二：纵轴是“白色毛刺斑块的数量或密度”；横轴是时间；

---

## 📢 最新更新 (2025年10月8日)

### ⭐ coil_wear_analysis.py 功能增强

**新增功能：**

1. **平滑长期趋势分析**
   - 集成3种高级平滑方法：移动最大值包络线、周期峰值样条插值、全局二次拟合
   - 生成图表：`smooth_longterm_trends.png`
   
2. **深度趋势分析**
   - 峰值包络线分析（自动判断趋势方向）
   - 分段趋势分析（统计递增段占比）
   - 低通滤波长期趋势（去除高频噪声）
   - 生成图表：`deep_envelope_analysis.png`, `deep_segment_analysis.png`, `deep_longterm_filtered.png`

**使用方法：**
```bash
python coil_wear_analysis.py \
  --roi_dir data/roi_imgs \
  --output_dir data_analysis \
  --name "视频分析"
```

**功能对比：**

| 特性 | coil_wear_analysis.py | main_analysis.py |
|-----|----------------------|------------------|
| **钢卷边界检测** | ✅ 自动检测（基于ruptures） | ❌ 需手动指定参数 |
| **综合指标** | ✅ 3种方法（加权/PCA/多维度） | ❌ 无 |
| **平滑趋势** | ✅ 已集成（单脚本） | ✅ 需调用子脚本 |
| **深度分析** | ✅ 已集成（单脚本） | ✅ 需调用子脚本 |
| **运行方式** | 🎯 一键运行，自动化程度高 | 🔧 模块化，灵活性高 |

**详细文档：**
- 📖 [CHANGELOG_coil_wear_analysis.md](CHANGELOG_coil_wear_analysis.md) - 技术更新日志
- 📘 [USAGE_EXAMPLE.md](USAGE_EXAMPLE.md) - 详细使用指南

---

## 📊 撕裂面白色斑块分析 (新增)

基于用户观察："撕裂面白色斑块随剪刀磨损增加而增多"，本功能提供专门的白斑量化分析。

### 功能特点

1. **4种检测方法对比**
   - 方法1：固定阈值法（灰度值 > 200）
   - 方法2：Otsu自适应阈值法（带最小阈值约束170，平衡检测精度）
   - 方法3：相对亮度法（均值 + 1.5σ）
   - 方法4：形态学Top-Hat法（局部对比度）

2. **8种量化指标**
   - 白色区域面积占比（%）
   - 白色斑块数量（连通域计数）
   - 平均亮度和亮度标准差
   - 单个白斑平均面积 - 白斑面积占比/白斑数量
   - 综合指标 - 白斑数量+亮度标准差
   - 亮度直方图熵 - 反映白斑亮度分布的复杂度
   - **斑块面积分布熵（新增）** - 反映白斑大小分布的均匀性

3. **双模式分析**
   - **集成模式**：自动集成到主分析流程（32个白斑特征）
   - **独立模式**：详细的方法对比和推荐报告

### 使用方法

**集成模式（自动）：**
```bash
python coil_wear_analysis.py \
  --roi_dir data/roi_imgs \
  --output_dir data/coil_analysis \
  --name "视频分析"
```
输出包含：
- `white_patch_analysis.png` - 白斑分析专项图
- `wear_features.csv` - 包含32个白斑特征列（4方法×8指标）
- `analysis_report.md` - 含白斑变化结论

**独立模式（详细分析）：**
```bash
python tear_surface_white_patch_analyzer.py \
  --roi_dir data/roi_imgs \
  --output_dir data/white_patch_analysis \
  --marker_interval 100
```
输出包含：
- `method_comparison.png` - 4种方法检测效果对比
- `temporal_curves_4x8.png` - **32条时序曲线**（4方法×8指标）
- `coil_statistics.png` - 按卷统计分析
- `method_recommendation.md` - 方法推荐报告
- `white_patch_features.csv` - 详细特征数据（32列）
- `white_patch_markers/` - **白斑标注图目录（每隔N帧）** - 新增直方图对比
  - 3×2布局：上方4个标注图 + 下方2个直方图
  - 左下：撕裂面亮度直方图（整体 vs 4种方法的白斑）
  - 右下：白斑面积分布直方图（4种方法对比）
  - 红色圆圈标注白斑位置，绿色点标记质心

### 输出示例

**时序分析：**
- 第一行：4种方法的白斑面积占比变化曲线
- 第二行：4种方法的白斑数量变化曲线
- 第三行：4种方法的平均亮度变化曲线
- 第四行：4种方法的亮度标准差变化曲线
- 第五行：4种方法的单个白斑平均面积变化曲线
- 第六行：4种方法的综合指标变化曲线 - 数量+亮度标准差
- 第七行：4种方法的亮度直方图熵变化曲线 - 反映亮度分布复杂度
- **第八行：4种方法的斑块面积分布熵变化曲线（新增）** - 反映白斑大小分布均匀性

**白斑标注可视化（增强版）：**
- **3×2布局**：上方4个标注图 + 下方2个直方图对比
- **上方标注图**：
  - 红色圆圈标注每个白斑（圆圈大小反映面积）
  - 绿色点标记白斑质心
  - 黄色标签显示白斑数量
- **左下直方图**：撕裂面亮度分布对比
  - 灰色：撕裂面整体亮度分布
  - 彩色：4种方法检测到的白斑亮度分布
- **右下直方图**：白斑面积分布对比
  - 展示4种方法检测到的斑块面积分布
  - 可看出白斑大小的分布特征
- 默认每隔100帧生成一张（可通过 `--marker_interval` 参数调整）

**方法推荐：**
基于单调性、稳定性和灵敏度的综合评分，自动推荐最佳检测方法。

### 参数说明

独立脚本参数：
- `--roi_dir`: ROI图像目录（必需）
- `--output_dir`: 输出目录（必需）
- `--coil_csv`: 包含卷号信息的CSV文件（可选）
- `--marker_interval`: 白斑标注采样间隔，默认100（每隔100帧生成一张标注图）

### 技术细节

**特征命名规则：**
- `white_area_ratio_m1/m2/m3/m4` - 白斑面积占比（%）
- `white_patch_count_m1/m2/m3/m4` - 白斑数量（个）
- `white_avg_brightness_m1/m2/m3/m4` - 平均亮度
- `white_brightness_std_m1/m2/m3/m4` - 亮度标准差
- `white_avg_patch_area_m1/m2/m3/m4` - 单个白斑平均面积（%）
- `white_composite_index_m1/m2/m3/m4` - 综合指标（数量+亮度std）
- `white_brightness_entropy_m1/m2/m3/m4` - 亮度直方图熵
- `white_patch_area_entropy_m1/m2/m3/m4` - **斑块面积分布熵（新增）**

**适用场景：**
- 撕裂面质量评估
- 剪刀磨损状态监控
- 与其他磨损指标综合判断

**指标详解：**

1. **白斑面积占比** - 白斑总面积占撕裂面的百分比
2. **白斑数量** - 连通域计数，反映白斑碎片化程度
3. **平均亮度** - 白斑区域的平均灰度值
4. **亮度标准差** - 白斑亮度的离散程度
5. **单个白斑平均面积** - 面积/数量，反映白斑平均尺寸
6. **综合指标** - 数量+亮度std，快速评估严重程度
7. **亮度直方图熵** - 反映亮度分布复杂度（0-5，越高越复杂）
8. **斑块面积分布熵** - 反映白斑大小分布均匀性（0-4.3，越高白斑大小差异越大）

**方法对比：**

| 方法 | 阈值策略 | 优点 | 适用场景 |
|-----|---------|------|---------|
| 方法1 | 固定200 | 稳定可靠 | 光照稳定 |
| 方法2 | Otsu+170约束 | 自适应且有下限 | 通用场景 |
| 方法3 | 均值+1.5σ | 相对统计 | 局部亮度变化 |
| 方法4 | Top-Hat | 检测凸起 | 小亮点检测 |

**阈值调整：**
- Otsu方法当前最小阈值：170
- 如需调整：修改 `geometry_features.py` (562行) 和 `tear_surface_white_patch_analyzer.py` (110行)
- 建议范围：160-185

---

**模型信息：** Claude Sonnet 4.5 (claude-sonnet-4-20250514)  
**更新日期：** 2025年10月9日
