# 梯度等高线检测功能说明

## 功能概述

本功能实现了检测final mask右边缘线往左第一条梯度等高线的功能，包括：

1. **梯度等高线检测**: 从右边缘线向左搜索第一条梯度变化点
2. **插值和平滑**: 对检测到的等高线进行上下方向插值和平滑滤波
3. **可视化**: 生成包含4个子图的综合分析可视化

## 核心功能

### 1. 梯度等高线检测 (`detect_gradient_contour_from_right_edge`)

**功能**: 检测final mask右边缘线往左第一条梯度等高线

**参数**:
- `binary_img`: 二值图像 (0/255)
- `gradient_threshold`: 梯度阈值 (0-1)，默认0.3
- `search_width`: 从右边缘向左搜索的宽度，默认50像素
- `edge_sigma`: 边缘平滑的sigma值，默认5.0

**返回**:
- `contour_x`: 等高线的x坐标数组
- `contour_y`: 等高线的y坐标数组  
- `right_edges`: 右边缘线坐标
- `gradient_map`: 梯度图

**算法原理**:
1. 计算Final Mask的右边缘线
2. 对右边缘线进行高斯平滑处理
3. 使用Sobel算子计算水平梯度（从右向左）
4. 沿右边缘线向左搜索梯度变化点
5. 根据阈值筛选有效的等高线点

### 2. 插值和平滑 (`interpolate_and_smooth_contour`)

**功能**: 对等高线进行上下方向插值和平滑滤波

**参数**:
- `contour_x, contour_y`: 原始等高线坐标
- `image_height`: 图像高度
- `smoothing_sigma`: 平滑滤波的sigma值，默认3.0

**返回**:
- `smooth_x, smooth_y`: 平滑后的等高线坐标

**算法原理**:
1. 创建完整的y坐标范围
2. 使用线性插值填补缺失的y坐标
3. 应用高斯平滑滤波
4. 确保坐标在有效范围内

### 3. 可视化 (`visualize_gradient_contour_detection`)

**功能**: 生成4个子图的综合分析可视化

**子图内容**:
1. **原始图像 + 右边缘线 + 检测到的等高线**: 显示检测结果
2. **梯度图**: 显示梯度强度分布
3. **等高线X坐标变化**: 显示等高线随Y坐标的变化
4. **右边缘线与等高线对比**: 显示距离分析

## 使用方法

### 命令行使用

```bash
# 基本使用
python test_count_black_strips.py --gradient_contour

# 自定义参数
python test_count_black_strips.py --gradient_contour \
    --gradient_threshold 0.2 \
    --search_width 60 \
    --smoothing_sigma 2.0

# 指定输入图像
python test_count_black_strips.py image_path --gradient_contour
```

### 参数说明

- `--gradient_contour`: 启用梯度等高线检测功能
- `--gradient_threshold`: 梯度阈值 (0-1)，默认0.3
- `--search_width`: 搜索宽度，默认50像素
- `--smoothing_sigma`: 平滑滤波sigma，默认3.0

### 演示脚本

```bash
# 运行演示脚本
python test_gradient_contour_demo.py [image_path]
```

## 输出结果

### 1. 控制台输出
- 检测到的等高线点数量
- 平滑后等高线长度
- 统计信息（坐标范围、距离分析等）

### 2. 可视化图像
生成包含4个子图的综合分析图像：
- 左上：原始图像 + 检测结果
- 右上：梯度图
- 左下：等高线X坐标变化
- 右下：右边缘线与等高线对比

### 3. 统计信息
- 等高线点分布（X、Y坐标范围）
- 右边缘到等高线的距离分析
- 平均距离、最小距离、最大距离

## 技术特点

### 1. 梯度计算
- 使用Sobel算子计算水平梯度
- 从右向左的梯度方向（检测白到黑的变化）
- 取负值以突出边缘变化

### 2. 边缘平滑
- 对右边缘线进行高斯平滑
- 插值填补缺失行
- 确保边缘线的连续性

### 3. 等高线检测
- 逐行搜索梯度变化点
- 基于阈值的筛选机制
- 排除右边缘线本身

### 4. 插值和平滑
- 线性插值填补缺失点
- 高斯平滑滤波
- 边界条件处理

## 应用场景

1. **边缘检测**: 检测图像中的边缘变化
2. **轮廓分析**: 分析物体的轮廓特征
3. **质量检测**: 检测产品表面的缺陷
4. **医学图像**: 分析医学图像中的结构变化

## 注意事项

1. **输入图像**: 需要是二值图像（0/255）
2. **参数调优**: 根据具体应用调整梯度阈值和搜索宽度
3. **性能考虑**: 大图像处理时注意内存使用
4. **结果验证**: 建议结合可视化结果验证检测效果

## 扩展功能

可以基于此功能进一步开发：
1. 多尺度梯度检测
2. 自适应阈值选择
3. 等高线质量评估
4. 批量处理功能
5. 实时检测应用
