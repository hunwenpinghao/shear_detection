# 剪刀磨损程度分析系统

## 项目概述

本项目实现了基于图像处理的剪刀磨损程度分析系统，通过提取几何特征和统计指标来量化剪刀刀口在使用过程中的磨损变化。系统采用模块化设计，实现了从图像预处理、特征提取到可视化分析的完整流程。

**核心功能**：
- 图像预处理：去噪、中心线检测、ROI划分
- 几何特征提取：RMS粗糙度、梯度能量、缺口深度、峰密度、面积比
- 时序分析：验证磨损递增趋势
- 可视化：单帧诊断图、时序曲线、相关性分析

## 项目结构

```
wear_degree_analysis/
├── src/
│   ├── utils.py              # 通用工具函数（文件操作、数据处理）
│   ├── preprocessor.py       # 预处理模块（去噪、中心线检测、ROI划分）
│   ├── geometry_features.py  # 几何特征提取模块（5个核心指标）
│   └── visualizer.py         # 可视化模块（诊断图、趋势图、统计图）
├── main_analysis.py          # 主程序入口
├── results/
│   ├── features/             # 特征数据（CSV & JSON）
│   │   ├── wear_features.csv
│   │   └── wear_features.json
│   ├── visualizations/       # 可视化结果
│   │   ├── temporal_trends.png          # 时序趋势曲线
│   │   ├── feature_correlations.png     # 特征相关性分析
│   │   ├── wear_progression.png         # 磨损递进综合图
│   │   └── frame_diagnosis/             # 单帧诊断图（前10帧）
│   └── analysis_report.md    # 分析报告
└── README.md                 # 本文档
```

## 核心算法

### 1. 预处理流程

**去噪**：使用高斯滤波（σ=1.0）平滑图像，保留边缘信息

**中心线检测**：
- 在白色区域内逐行扫描，检测局部最暗点
- 使用Savitzky-Golay滤波平滑中心线坐标
- 将不规则弯曲标准化为沿中轴的一维剖面序列

**ROI划分**：根据中心线分离左侧（撕裂面）和右侧（剪切面）

**法线采样**：沿中心线生成水平法线，采样两侧intensity profiles

### 2. 核心特征指标

#### 2.1 边界RMS粗糙度（优先级1）
- **定义**：边界位置序列的均方根偏差
- **计算**：`RMS = sqrt(mean((x_i - mean(x))^2))`
- **物理意义**：刀口位置沿中轴的抖动幅度，磨损增大时通常增大

#### 2.2 边界梯度能量（优先级2）
- **定义**：ROI区域的Tenengrad梯度能量
- **计算**：`E = mean(|∇I|^2)` 使用Sobel算子
- **物理意义**：锐度指标，刀口钝化时梯度能量下降

#### 2.3 最大缺口深度（优先级3）
- **定义**：边界位置与多项式拟合线的最大负偏差
- **计算**：多项式拟合 → 计算残差 → 取最大凹陷
- **物理意义**：代表最严重的局部损伤或缺口

#### 2.4 峰密度与峰统计（优先级4）
- **定义**：边界位置序列中的峰值密度
- **计算**：使用`scipy.signal.find_peaks`检测峰值
- **统计量**：峰数量、平均峰高、平均峰间距
- **物理意义**：更多的峰表示更多微缺口和不规则性

#### 2.5 撕裂/剪切区面积比（优先级5）
- **定义**：左侧撕裂区与右侧剪切区的面积比
- **计算**：二值化分割 → 根据中心线统计左右面积
- **物理意义**：磨损严重时撕裂区通常变大

### 3. 磨损趋势验证

系统通过以下方式验证磨损递增趋势：
- 计算每个特征的线性趋势斜率
- 检查关键指标（RMS粗糙度、缺口深度）是否呈递增趋势
- 计算综合磨损指数（多个指标的归一化加权平均）

## 运行方法

### 环境要求

```bash
Python 3.7+
opencv-python
numpy
scipy
matplotlib
seaborn
pandas
tqdm
```

### 安装依赖

```bash
pip install opencv-python numpy scipy matplotlib seaborn pandas tqdm
```

### 运行分析

```bash
cd wear_degree_analysis
python main_analysis.py
```

程序将自动：
1. 读取 `../data/roi_imgs/` 目录下的前100帧图像
2. 对每帧进行预处理和特征提取
3. 生成前10帧的详细诊断图
4. 生成时序趋势曲线、相关性分析、磨损递进图
5. 保存特征数据（CSV & JSON）和分析报告

### 输出结果

**特征数据**：
- `results/features/wear_features.csv`：所有特征的CSV格式
- `results/features/wear_features.json`：所有特征的JSON格式

**可视化**：
- `results/visualizations/temporal_trends.png`：6个核心特征的时序变化
- `results/visualizations/feature_correlations.png`：特征相关性矩阵和统计分析
- `results/visualizations/wear_progression.png`：综合磨损指数的递进趋势
- `results/visualizations/frame_diagnosis/`：前10帧的详细诊断图

**报告**：
- `results/analysis_report.md`：包含统计摘要、趋势验证、异常检测的完整报告

## 结果解读

### ⚠️ 重要发现：周期性波动模式

通过对**完整2249帧**数据的分析，发现了一个关键现象：

**磨损指标并非单调递增，而是呈现明显的周期性波动**：
- 📊 大约每300-400帧出现一次大幅下降
- 🔄 这很可能对应每卷钢卷的切换或工况变化
- 📈 在每个周期内部可能有递增趋势，但周期间会重置

### 数据对比：前100帧 vs 全部数据

| 数据范围 | RMS粗糙度趋势 | 缺口深度趋势 | 结论 |
|---------|--------------|-------------|------|
| **前100帧** | +0.00958 ✓ | +0.06618 ✓ | 局部递增 |
| **全部2249帧** | -0.00040 ✗ | -0.00128 ✗ | 整体平稳/周期性 |

**关键洞察**：
- ✅ 前100帧的递增趋势**是真实的**，代表单卷内的磨损递增
- ⚠️ 但简单的线性拟合**不适用于**跨卷的长期分析
- 🎯 需要**按卷分段分析**或**去除周期性**后再评估长期趋势

### 典型特征值范围（全部2249帧）

| 特征 | 均值 | 标准差 | 范围 |
|------|------|--------|------|
| 平均RMS粗糙度 | 5.16 | 2.31 | [0.00, 10.36] |
| 平均梯度能量 | 4034.33 | 1658.35 | [471.88, 8544.24] |
| 最大缺口深度 | 13.19 | 6.64 | [0.00, 30.96] |
| 左侧峰密度 | 0.225 | 0.059 | [0.00, 0.340] |
| 撕裂/剪切面积比 | 1.04 | 0.24 | [0.30, 4.17] |

### 数据质量

- **成功率**: 2249/2333 = 96.4%
- **失败帧**: 84帧（主要集中在卷切换阶段）
- **异常值**: 特征值为0的帧可能对应无有效ROI的情况

## 下一步扩展方向

### 🎯 优先级1：处理周期性波动（最重要）

**问题**：当前简单线性拟合无法捕捉真实趋势

**解决方案**：
1. **按卷分段分析**
   - 自动检测卷切换点（通过特征突变）
   - 计算每卷内部的磨损趋势
   - 比较不同卷的初始/结束状态

2. **周期性去除**
   - 使用小波变换或滤波器去除周期分量
   - 提取长期趋势线
   - 分析残差中的短期波动

3. **改进的趋势度量**
   - 峰值包络线分析（取每个周期的最大值）
   - 分段线性拟合
   - 移动平均后的趋势

### 2. 特征扩展
- **纹理特征**：GLCM（灰度共生矩阵）、LBP（局部二值模式）
- **频域特征**：FFT主频、高频能量比、谱斜率
- **分形特征**：分形维数、Hurst指数
- **边界曲率**：弯曲度、尖锐角统计

### 3. 无监督学习
- K-means聚类自动分级磨损程度（按卷或按阶段）
- PCA降维可视化特征空间
- 异常检测（Isolation Forest识别异常帧）
- 时序聚类（DTW距离）识别相似模式

### 4. 时序建模
- 分段ARIMA模型（每卷独立建模）
- 变点检测识别卷切换点
- 滑动窗口分析局部磨损率
- 状态空间模型捕捉隐藏状态

### 5. 工程化部署
- 实时阈值告警机制（基于历史统计）
- Web界面展示趋势和诊断
- 批量处理优化（多进程并行）
- 与生产管理系统集成

## 技术特点

1. **模块化设计**：预处理、特征提取、可视化完全解耦，易于扩展
2. **鲁棒性**：使用Savitzky-Golay滤波平滑中心线，处理弯曲和噪声
3. **可解释性**：所有特征都有明确的物理意义和计算公式
4. **可视化完善**：提供单帧诊断、时序趋势、相关性分析等多维度可视化

## 常见问题

### Q1: 中心线检测不准确怎么办？
**A**: 调整`ImagePreprocessor`的参数：
- 增大`gaussian_sigma`以增强平滑
- 调整`savgol_window`窗口大小（必须为奇数）
- 检查图像亮度阈值（当前为100）

### Q2: 如何处理更多帧？
**A**: 修改`main_analysis.py`中的`max_frames`参数：
```python
analyzer = WearDegreeAnalyzer(
    data_dir=data_dir,
    output_dir=output_dir,
    max_frames=500  # 修改为需要的帧数
)
```

### Q3: 如何添加新特征？
**A**: 在`geometry_features.py`的`GeometryFeatureExtractor`类中：
1. 添加新的特征计算方法
2. 在`extract_features`方法中调用
3. 更新返回字典

### Q4: 内存不足怎么办？
**A**: 
- 减少同时处理的帧数
- 减少保存的诊断图数量（修改`save_diagnosis`条件）
- 使用生成器逐帧处理而非全部加载

## 参考文献

本项目基于以下理论和方法：
1. 表面粗糙度测量：ISO 4287标准
2. 图像锐度评价：Tenengrad算法
3. 信号峰值检测：`scipy.signal.find_peaks`
4. 边缘检测：Sobel算子

## 作者与维护

本项目为剪刀磨损程度指标探索的实现方案，用于钢卷剪切设备的磨损监测。

---

**最后更新**：2025-10-02

